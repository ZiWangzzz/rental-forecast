<!DOCTYPE html>
<html>
<head>
    <title>长租公寓现金流预测系统</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .container { max-width: 1200px; margin: 0 auto; padding: 20px }
        .input-section { background: #f5f5f5; padding: 20px; border-radius: 8px }
        .chart-container { margin-top: 30px }
        .contract-item { margin-bottom: 15px; padding: 10px; border: 1px solid #ddd }
        input { width: 150px; margin-right: 10px }
        button { background: #4CAF50; color: white; border: none; padding: 8px 15px }
    </style>
</head>
<body>
    <div class="container">
        <div class="input-section">
            <h2>租赁合同输入</h2>
            <div id="contracts">
                <div class="contract-item">
                    起租日期: <input type="date" class="start-date">
                    客户数: <input type="number" class="quantity" min="1" value="1">
                    租期(月): <input type="number" class="term" min="1" value="12">
                    月租金: <input type="number" class="rent" min="0" value="3000">
                    <button onclick="removeContract(this)">删除</button>
                </div>
            </div>
            <button onclick="addContract()">添加合同</button>
            <button onclick="calculate()">开始计算</button>
        </div>

        <div class="chart-container">
            <canvas id="expirationChart"></canvas>
        </div>
    </div>

<script>
let chart = null;

function addContract() {
    const newContract = $(`<div class="contract-item">
        起租日期: <input type="date" class="start-date">
        客户数: <input type="number" class="quantity" min="1" value="1">
        租期(月): <input type="number" class="term" min="1" value="12">
        月租金: <input type="number" class="rent" min="0" value="3000">
        <button onclick="removeContract(this)">删除</button>
    </div>`);
    $('#contracts').append(newContract);
}

function removeContract(button) {
    $(button).parent().remove();
}

function parseDate(dateStr) {
    const [year, month] = dateStr.split('-').map(Number);
    return { year, month };
}

function calculate() {
    const contracts = [];
    $('.contract-item').each(function() {
        const contract = {
            startDate: $(this).find('.start-date').val(),
            quantity: parseInt($(this).find('.quantity').val()),
            term: parseInt($(this).find('.term').val()),
            rent: parseFloat($(this).find('.rent').val())
        };
        if (contract.startDate) contracts.push(contract);
    });

    const results = {};
    contracts.forEach(contract => {
        const start = parseDate(contract.startDate);
        const endMonth = start.month + contract.term;
        
        const expirationYear = start.year + Math.floor((endMonth - 1)/12);
        const expirationMonth = ((endMonth - 1) % 12) + 1;
        
        const key = `${expirationYear}-${String(expirationMonth).padStart(2, '0')}`;
        results[key] = results[key] || { count: 0, revenue: 0 };
        results[key].count += contract.quantity;
        results[key].revenue += contract.quantity * contract.rent;
    });

    const sortedKeys = Object.keys(results).sort();
    const labels = sortedKeys.map(k => `${k.split('-')[0]}年${parseInt(k.split('-')[1])}月`);
    const counts = sortedKeys.map(k => results[k].count);
    const revenues = sortedKeys.map(k => results[k].revenue);

    renderChart(labels, counts, revenues);
}

function renderChart(labels, counts, revenues) {
    const ctx = document.getElementById('expirationChart').getContext('2d');
    
    if (chart) chart.destroy();

    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '到期客户数',
                data: counts,
                borderColor: 'rgb(255, 99, 132)',
                yAxisID: 'y'
            }, {
                label: '租金收入（元）',
                data: revenues,
                borderColor: 'rgb(54, 162, 235)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: '客户数' }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: '收入（元）' },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
}
</script>
</body>
</html>